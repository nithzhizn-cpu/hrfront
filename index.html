<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>AI HR Psychologist · HR Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <!-- В проді: заміни BACKEND_URL -->
  <script>
    window.BACKEND_URL = "https://compassionate-recreation-production-9b4b.up.railway.app";
  </script>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="logo">AI HR<span>·Psychologist</span></div>
      <div class="top-actions">
        <span class="badge" id="plan-badge">Plan: —</span>
      </div>
    </header>

    <main class="main">
      <aside class="sidebar">
        <h2>Кандидати</h2>
        <div id="candidate-list" class="candidate-list">Авторизуйтесь...</div>

        <h2 class="tests-title">Доступні тести</h2>
        <div id="tests-list" class="tests-list">Авторизуйтесь...</div>

        <h2 class="tests-title">Тариф</h2>
        <div class="billing-box">
          <div id="billing-info" class="billing-info">—</div>
          <button id="activate-demo-btn">Активувати PRO демо (14 днів)</button>
        </div>
      </aside>

      <section class="content">
        <div id="welcome" class="welcome-card">
          <h1>Панель HR-аналітики</h1>
          <p>
            Увійдіть як HR, використовуючи свій <b>Admin Key</b>, щоб бачити кандидатів,
            результати тестів, аналіз голосу/фото та завантажувати PDF-звіти.
          </p>
        </div>

        <div id="candidate-detail" class="candidate-detail hidden">
          <div class="detail-header">
            <div>
              <h1 id="cd-name"></h1>
              <p id="cd-meta" class="meta"></p>
            </div>
            <div class="pill" id="cd-risk">Ризик: —</div>
          </div>

          <div class="cards-row">
            <div class="card">
              <h2>Профіль за шкалами</h2>
              <div id="scores" class="scores-grid"></div>
            </div>
            <div class="card">
              <h2>Короткий опис</h2>
              <p id="cd-summary"></p>
            </div>
          </div>

          <div class="cards-row">
            <div class="card">
              <h2>Голосовий аналіз</h2>
              <div id="voice-block"></div>
            </div>
            <div class="card">
              <h2>Фотоаналіз</h2>
              <div id="photo-block"></div>
            </div>
          </div>

          <div class="card">
            <h2>Рекомендації щодо роботи з кандидатом</h2>
            <ul id="cd-recs"></ul>
          </div>

          <div class="card pdf-card">
            <button id="pdf-btn">Завантажити PDF-звіт</button>
          </div>
        </div>
      </section>
    </main>

    <div id="login-overlay" class="login-overlay">
      <div class="login-card">
        <h2>Вхід HR</h2>
        <p>Введіть свій <b>Admin Key</b> (повинен співпадати зі змінною <code>ADMIN_API_KEY</code> на бекенді).</p>
        <input type="password" id="admin-key-input" placeholder="ADMIN KEY" />
        <button id="login-btn">Увійти</button>
        <p class="login-hint">Для локальних тестів значення за замовчуванням: <code>DEV_ADMIN_KEY</code></p>
      </div>
    </div>
  </div>

  <script>
    const API_ROOT = (window.BACKEND_URL || "http://localhost:8000") + "/api";
    let ADMIN_KEY = null;
    let CURRENT_CANDIDATE_ID = null;

    function getHeaders() {
      const h = {};
      if (ADMIN_KEY) {
        h["X-Admin-Key"] = ADMIN_KEY;
      }
      return h;
    }

    async function fetchJSON(url, options = {}) {
      const merged = {
        ...options,
        headers: {
          ...(options.headers || {}),
          ...getHeaders(),
        },
      };
      const res = await fetch(url, merged);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      if (res.headers.get("Content-Type")?.includes("application/json")) {
        return await res.json();
      }
      return await res.text();
    }

    function el(tag, cls, text) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (text) e.textContent = text;
      return e;
    }

    async function loadBilling() {
      const info = document.getElementById("billing-info");
      const badge = document.getElementById("plan-badge");
      try {
        const data = await fetchJSON(API_ROOT + "/billing/status");
        info.textContent = `План: ${data.plan} · Email: ${data.email}` + (data.demo_until ? ` · Демо до: ${data.demo_until}` : "");
        badge.textContent = "Plan: " + data.plan;
      } catch (err) {
        info.textContent = "Не вдалося завантажити білінг.";
        badge.textContent = "Plan: —";
      }
    }

    async function activateDemo() {
      const info = document.getElementById("billing-info");
      info.textContent = "Активація демо...";
      try {
        const data = await fetchJSON(API_ROOT + "/billing/activate_demo", { method: "POST" });
        info.textContent = `План: ${data.plan} · Email: ${data.email}` + (data.demo_until ? ` · Демо до: ${data.demo_until}` : "");
        document.getElementById("plan-badge").textContent = "Plan: " + data.plan;
      } catch (err) {
        info.textContent = "Помилка активації демо.";
      }
    }

    async function loadCandidates() {
      const list = document.getElementById("candidate-list");
      list.innerHTML = "Завантаження...";
      try {
        const data = await fetchJSON(API_ROOT + "/hr/candidates");
        list.innerHTML = "";
        if (!data.length) {
          list.textContent = "Поки немає кандидатів.";
          return;
        }
        data.forEach((c) => {
          const item = el("div", "candidate-item");
          item.innerHTML = `
            <div class="ci-title">${c.full_name || "Без імені"}</div>
            <div class="ci-sub">ID: ${c.id} · TG: ${c.tg_id || "—"}</div>
          `;
          item.onclick = () => loadCandidateDetail(c.id);
          list.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        list.textContent = "Помилка завантаження (перевірте Admin Key).";
      }
    }

    async function loadTestsList() {
      const box = document.getElementById("tests-list");
      box.innerHTML = "Завантаження...";
      try {
        const data = await fetchJSON(API_ROOT + "/tests");
        box.innerHTML = "";
        data.forEach((t) => {
          const card = el("div", "test-item");
          const title = el("div", "test-title", t.name);
          const code = el("div", "test-code", "Код: " + t.code);
          const traits = el("ul", "test-traits");
          Object.values(t.traits).forEach((v) => {
            const li = document.createElement("li");
            li.textContent = v;
            traits.appendChild(li);
          });
          card.appendChild(title);
          card.appendChild(code);
          card.appendChild(traits);
          box.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        box.textContent = "Помилка завантаження тестів.";
      }
    }

    function setRiskPill(level) {
      const pill = document.getElementById("cd-risk");
      pill.className = "pill";
      if (!level) {
        pill.textContent = "Ризик: —";
        return;
      }
      pill.textContent = "Ризик: " + level;
      pill.classList.add("pill-" + level);
    }

    async function loadCandidateDetail(id) {
      CURRENT_CANDIDATE_ID = id;
      const detail = document.getElementById("candidate-detail");
      const welcome = document.getElementById("welcome");
      welcome.classList.add("hidden");
      detail.classList.remove("hidden");

      document.getElementById("cd-name").textContent = "Завантаження...";
      document.getElementById("cd-meta").textContent = "";
      document.getElementById("cd-summary").textContent = "";
      document.getElementById("cd-recs").innerHTML = "";
      document.getElementById("scores").innerHTML = "";
      document.getElementById("voice-block").innerHTML = "";
      document.getElementById("photo-block").innerHTML = "";
      setRiskPill(null);

      try {
        const data = await fetchJSON(API_ROOT + "/hr/candidate/" + id);
        const { candidate, last_test, report, last_voice, last_photo } = data;

        document.getElementById("cd-name").textContent =
          candidate.full_name || "Без імені";
        document.getElementById("cd-meta").textContent =
          "ID: " + candidate.id + " · Створено: " + candidate.created_at;

        if (report && report.risk_level) {
          setRiskPill(report.risk_level);
        }

        if (report && report.summary) {
          document.getElementById("cd-summary").textContent = report.summary;
        } else {
          document.getElementById("cd-summary").textContent =
            "Немає збереженого опису.";
        }

        const ul = document.getElementById("cd-recs");
        ul.innerHTML = "";
        if (report && report.recommendations && report.recommendations.length) {
          report.recommendations.forEach((r) => {
            const li = document.createElement("li");
            li.textContent = r;
            ul.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.textContent = "Немає рекомендацій.";
          ul.appendChild(li);
        }

        const scoresDiv = document.getElementById("scores");
        scoresDiv.innerHTML = "";
        if (last_test && last_test.scores) {
          Object.entries(last_test.scores).forEach(([key, val]) => {
            const row = document.createElement("div");
            row.className = "score-row";
            const label = document.createElement("div");
            label.className = "score-label";
            label.textContent = key;
            const barWrap = document.createElement("div");
            barWrap.className = "score-bar-wrap";
            const bar = document.createElement("div");
            bar.className = "score-bar";
            const pct = Math.max(0, Math.min(100, (val / 5) * 100));
            bar.style.width = pct + "%";
            barWrap.appendChild(bar);
            const v = document.createElement("div");
            v.className = "score-value";
            v.textContent = val.toFixed(2) + " / 5";
            row.appendChild(label);
            row.appendChild(barWrap);
            row.appendChild(v);
            scoresDiv.appendChild(row);
          });
        } else {
          scoresDiv.textContent = "Немає результатів тесту.";
        }

        const voiceEl = document.getElementById("voice-block");
        if (last_voice) {
          voiceEl.innerHTML = `
            <div class="kv">
              <div class="kv-label">Стрес:</div>
              <div class="kv-value">${last_voice.stress_score.toFixed(
                2
              )} / 100 (${last_voice.level})</div>
            </div>
            <div class="kv">
              <div class="kv-label">Дата:</div>
              <div class="kv-value">${last_voice.created_at}</div>
            </div>
          `;
        } else {
          voiceEl.textContent = "Немає голосового аналізу.";
        }

        const photoEl = document.getElementById("photo-block");
        if (last_photo) {
          photoEl.innerHTML = `
            <div class="kv">
              <div class="kv-label">Настрій:</div>
              <div class="kv-value">${last_photo.mood}</div>
            </div>
            <div class="kv">
              <div class="kv-label">Втома:</div>
              <div class="kv-value">${last_photo.fatigue_level}</div>
            </div>
            <div class="kv">
              <div class="kv-label">Яскравість / контраст:</div>
              <div class="kv-value">${last_photo.brightness.toFixed(
                1
              )} / ${last_photo.contrast.toFixed(1)}</div>
            </div>
            <div class="kv">
              <div class="kv-label">Дата:</div>
              <div class="kv-value">${last_photo.created_at}</div>
            </div>
          `;
        } else {
          photoEl.textContent = "Немає результатів фотоаналізу.";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("cd-name").textContent = "Помилка";
        document.getElementById("cd-summary").textContent =
          "Не вдалося завантажити дані кандидата.";
      }
    }

    async function downloadPdf() {
      if (!CURRENT_CANDIDATE_ID) return;
      const url = API_ROOT + "/hr/candidate/" + CURRENT_CANDIDATE_ID + "/pdf";
      try {
        const res = await fetch(url, { headers: getHeaders() });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const blob = await res.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "candidate_" + CURRENT_CANDIDATE_ID + "_report.pdf";
        document.body.appendChild(link);
        link.click();
        link.remove();
      } catch (err) {
        alert("Помилка завантаження PDF.");
      }
    }

    function showAppAfterLogin() {
      document.getElementById("login-overlay").classList.add("hidden");
      document.getElementById("candidate-list").textContent = "Завантаження...";
      document.getElementById("tests-list").textContent = "Завантаження...";
      loadBilling();
      loadCandidates();
      loadTestsList();
      setInterval(loadCandidates, 20000);

      document.getElementById("pdf-btn").onclick = downloadPdf;
    }

    document.getElementById("login-btn").onclick = () => {
      const val = document.getElementById("admin-key-input").value.trim();
      if (!val) return;
      ADMIN_KEY = val;
      localStorage.setItem("hr_admin_key", val);
      showAppAfterLogin();
    };

    document.getElementById("activate-demo-btn").onclick = () => {
      activateDemo();
    };

    const stored = localStorage.getItem("hr_admin_key");
    if (stored) {
      ADMIN_KEY = stored;
      showAppAfterLogin();
    }
  </script>
</body>
</html>
